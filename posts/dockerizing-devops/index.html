<!DOCTYPE html>
<html lang="en-US">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, maximum-scale=1" />
  <meta name="author" content="Eliise Seling">
  <meta name="description" content="Reusing a devcontainer build environment for pipelines">
  
  <meta property="og:title" content="Dockerizing DevOps" />
<meta property="og:description" content="Reusing a devcontainer build environment for pipelines" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://eliises.github.io/posts/dockerizing-devops/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-07-08T17:00:13+00:00" />
<meta property="article:modified_time" content="2020-07-08T17:00:13+00:00" />
<meta property="og:see_also" content="https://eliises.github.io/posts/powershell-devcontainer/" />



  <title>
  
       Dockerizing DevOps | Eliise Seling 
  
  </title>

  <link rel="canonical" href="https://eliises.github.io/posts/dockerizing-devops/">

  
  

  
  <link href="https://eliises.github.io/vendors/fontawesome-free-5.14.0-web/css/all.min.css" rel="stylesheet">

  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700|Ubuntu+Mono:400,400i,700,700i|Raleway:300,400,500,600">
  <link href="https://eliises.github.io/css/font.css" rel="stylesheet"> 
    
  
  <link href="https://eliises.github.io/css/vendors/bootstrap4/bootstrap.min.css" rel="stylesheet">
  <link href="https://eliises.github.io/css/vendors-extensions/mdb/mdb.min.css" rel="stylesheet"> 
  <link href="https://eliises.github.io/css/vendors/mdb/style.min.css" rel="stylesheet"> 
  <link href="https://eliises.github.io/css/main.css" rel="stylesheet">


  
  <link rel="shortcut icon"
  
      href="https://eliises.github.io/img/zheng.png"
  
  >


  
  

  <style type="text/css">
      @media (min-width: 800px) and (max-width: 850px) {
              .navbar:not(.top-nav-collapse) {
                  background: #1C2331!important;
              }
          }
  </style>


  
    
    <link rel="stylesheet" href="https://eliises.github.io/js/vendors/katex/katex.min.css">
  
  

  
    
    <link rel="stylesheet" href="https://eliises.github.io/css/vendors/highlight/github-gist.css">
  

  
  
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-173967641-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  

</head>

  <body class="bg-light" data-spy="scroll" data-target="#page-scrollspy" data-offset="90">
  
    
    

    
      


<nav class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar">
    <div class="container">

      
      <a class="navbar-brand" href="https://eliises.github.io">
          
        <img class="avatar" src="https://eliises.github.io/img/zheng.png" style="width: 40px!important;height: auto;"  class="d-inline-block align-top" alt="" >
        
        <strong> Eliise Seling</strong>
      </a>

      
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
        aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      
      <div class="collapse navbar-collapse" id="navbarSupportedContent">

        
        <ul class="navbar-nav mr-auto ">
          <li class="nav-item ">
            <a class="nav-link" href="https://eliises.github.io">Home</a>
          </li>
             
            <li class="nav-item ">
              <a class="nav-link" href="https://eliises.github.io/posts/" >Posts  </a>
            </li>
          
             
            <li class="nav-item ">
              <a class="nav-link" href="https://eliises.github.io/about/" >About  </a>
            </li>
          
          
        </ul>

      </div>

    </div>
  </nav>
  
 
      
 






<div id="site-header" class="carousel slide carousel-fade" data-ride="carousel" style="height: 18rem;" >  

  
  
  

  
  <div class="carousel-inner" role="listbox">
    
      

        
        <div class="carousel-item active">
          <div class="view" style="background-image: url('https://eliises.github.io/img/header-slides/raw_1515691746.jpg'); background-repeat: no-repeat; background-size: cover;">

            
            <div class="mask rgba-black-light d-flex justify-content-center align-items-center">

              
              
              

            </div>
            

          </div>
        </div>
        
      
    
      

        
        <div class="carousel-item">
          <div class="view" style="background-image: url('https://eliises.github.io/img/header-slides//raw_1515847341.jpg'); background-repeat: no-repeat; background-size: cover;">

            
            <div class="mask rgba-black-light d-flex justify-content-center align-items-center">

            

            </div>
            

          </div>
        </div>
        
      
    

  
  </div>
  

  
  <div class="carousel-content text-center white-text wow fadeIn">
    <div class="row mx-0 headfont mt-3 pt-4">
      
      <div class="col-12 col-sm-5 align-middle">
        <a href="https://eliises.github.io">
          
            <img class="pull-right avatar avatar-md" src="https://eliises.github.io/images/avatar.jpg" alt="" >
          
        </a>
      </div>
      
      <div class="col-12 col-sm-7 text-left pl-2">
        <a href="https://eliises.github.io">
          <h1 class="mb-2 h1" style="font-weight: 300;" >
            <strong>Eliise Seling</strong>
          </h1>
        </a>
        

         
        <div class="mt-2" style="font-size: 1rem; color: white;">
          
  <a href="//github.com/eliises" target="_blank" rel="noopener me"><i class="fab fa-github pr-1" aria-hidden="true"></i></a>    







  <a href="//linkedin.com/in/eliises" target="_blank" rel="noopener me"><i class="fab fa-linkedin pr-1" aria-hidden="true"></i></a>





  <a href="//twitter.com/eliises" target="_blank" rel="noopener me"><i class="fab fa-twitter pr-1" aria-hidden="true"></i></a>







  <a href="//dev.to/eliises" target="_blank" rel="noopener me"><i class="fab fa-dev pr-1" aria-hidden="true"></i></a>







  <a href="mailto:selingeliise@gmail.com"><i class="far fa-envelope-open pr-1" aria-hidden="true"></i></a>




        </div>
      </div>
    </div>
  </div>
  

  
  
  

</div>
  
    

    
  
  <main class="post-main-wrapper">
    
    
    <div class="row">

      

      
      <div class="col-md-10">
      

        
        <div class="z-depth-1 post-wrapper white-bg single-post dont-break-out">

          <div class="post-header text-center" >
  <ul class="post-meta li-x">
    
  
    <li><a href="https://eliises.github.io/categories/devops"><i class="fas fa-folder-open pr-1" aria-hidden="true"></i> devops </a></li>
  
    <li><a href="https://eliises.github.io/categories/vscode"><i class="fas fa-folder-open pr-1" aria-hidden="true"></i> vscode </a></li>
  
  
  
  
    <li><a href="https://eliises.github.io/series/devcontainer"><i class="fas fa-bookmark pr-1" aria-hidden="true"></i>devcontainer</a></li>
  

  </ul>
  <div class="px-4 post-heading">Dockerizing DevOps</div>
<ul class="post-meta li-x mt-1">
  
    <li>Jul 8, 2020</li>
  

  
    <li class="middot"></li>
    <li>5 minute read</li>
  
</ul>


  
    <div class="view">
      <img src="https://eliises.github.io/images/dockerizing-devops/devops-loop.svg" />
    </div>
  
</div>


          <div class="post-content markdown">
            <p>In this post I&rsquo;d like to present how to reuse a <a href="https://code.visualstudio.com/docs/remote/containers">devcontainer</a> as the build environment for pipelines. A devcontainer is a Docker container used as full-featured development environment. To learn more about what makes devcontainers awesome, see <a href="https://stuartleeks.com/posts/vscode-devcontainers/">Visual Studio Code and Devcontainers article</a> by my dear friend, Stuart Leeks.</p>
<p>A typical CI pipeline consists of <code>source -&gt; build -&gt; test</code> stages. Both build and test stages have dependencies (on software and configuration) that need to be configured within the pipeline itself. Since these dependencies are already setup in your <code>devcontainer</code>, why not just use that environment to run your build and tests in?</p>
<p>While the examples below use <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/yaml-schema?view=azure-devops&amp;tabs=schema%2Cparameter-schema">AzDO YAML pipelines</a>, this can be achieved with any CI environment. Lawrence Gripper&rsquo;s <a href="https://github.com/lawrencegripper/azbrowse">AzBrowze</a> is an example of a repository using devcontainer pipelines with <a href="https://github.com/features/actions">Github Actions</a>.</p>
<p>All code snippets can be found in <a href="https://github.com/EliiseS/terraform-pester-devcontainer-example">terraform-pester-devcontainer-example repository</a>.</p>
<h2 id="requirements">Requirements</h2>
<ul>
<li>Intermediate knowledge of <a href="https://docs.docker.com/">Docker</a>, <a href="https://code.visualstudio.com/docs/remote/containers">devcontainers</a> and CI/CD pipelines</li>
<li>Basic knowledge of <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/yaml-schema?view=azure-devops&amp;tabs=schema%2Cparameter-schema">AzDO YAML pipelines</a> and <a href="https://opensource.com/article/18/8/what-how-makefile">Makefiles</a> is helpful</li>
</ul>
<h2 id="about-the-project">About the project</h2>
<p>I&rsquo;ve created the <a href="https://github.com/EliiseS/terraform-pester-devcontainer-example">terraform-pester-devcontainer-example repository</a> to demonstrate devcontainer pipelines. The project consists of:</p>
<ul>
<li><a href="https://github.com/EliiseS/terraform-pester-devcontainer-example/blob/master/main.tf">terraform</a> to provision resources in Azure Devops</li>
<li><a href="https://github.com/EliiseS/terraform-pester-devcontainer-example/blob/master/tfIntegration.tests.ps1">tests</a> covering the terraform written in Pester, a PowerShell testing framework
<ul>
<li>More about testing terraform with Pester <a href="https://dev.to/eliises/testing-terraform-with-pester-1b01">in my previous post</a></li>
</ul>
</li>
<li><a href="https://github.com/EliiseS/terraform-pester-devcontainer-example/blob/master/.devcontainer/Dockerfile">devcontainer</a> with the development environment</li>
</ul>
<h3 id="ci-pipeline-checks">CI pipeline checks</h3>
<p>In a CI pipeline for this project we want to:</p>
<ul>
<li>validate terraform with tflint</li>
<li>run the Pester tests</li>
<li>validate the devcontainer can be built</li>
</ul>
<h2 id="classic-pipeline">Classic pipeline</h2>
<p>In a classic or standard pipeline, we first install the dependencies in the pipeline and then run our checks:</p>
<h5 id="azdoclassic-pipelineymlhttpsgithubcomeliisesterraform-pester-devcontainer-exampleblobmasterazdoclassic-pipelineyml"><a href="https://github.com/EliiseS/terraform-pester-devcontainer-example/blob/master/.azdo/classic-pipeline.yml">.azdo/classic-pipeline.yml</a></h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="w"> </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># Install dependencies</span><span class="w">
</span><span class="w">      </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">TerraformInstaller@0</span><span class="w">
</span><span class="w">        </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Install terraform&#39;</span><span class="w">
</span><span class="w">        </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">terraformVersion</span><span class="p">:</span><span class="w"> </span><span class="m">0.12.25</span><span class="w">
</span><span class="w">
</span><span class="w">      </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">Bash@3</span><span class="w">
</span><span class="w">        </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Install tflint</span><span class="w">
</span><span class="w">        </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">targetType</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;inline&#39;</span><span class="w">
</span><span class="w">          </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">            curl -L https://github.com/terraform-linters/tflint/releases/download/v0.17.0/tflint_linux_amd64.zip -o tflint.zip
</span><span class="sd">            unzip tflint.zip
</span><span class="sd">            rm tflint.zip
</span><span class="sd">            sudo mv tflint /usr/local/bin \</span><span class="w">            
</span><span class="w">
</span><span class="w">      </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">PowerShell@2</span><span class="w">
</span><span class="w">        </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Install Pester module</span><span class="w">
</span><span class="w">        </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">targetType</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;inline&#39;</span><span class="w">
</span><span class="w">          </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l">Install-Module -Name Pester -Force -RequiredVersion 4.10.1</span><span class="w">
</span><span class="w">
</span><span class="w">      </span><span class="c"># Run checks</span><span class="w">
</span><span class="w">      </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">PowerShell@2</span><span class="w">
</span><span class="w">        </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Validate terraform</span><span class="w">
</span><span class="w">        </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">targetType</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;inline&#39;</span><span class="w">
</span><span class="w">          </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">            terraform init
</span><span class="sd">            terraform validate
</span><span class="sd">            tflint</span><span class="w">            
</span><span class="w">
</span><span class="w">      </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">PowerShell@2</span><span class="w">
</span><span class="w">        </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Run tests</span><span class="w">
</span><span class="w">        </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">AZURE_DEVOPS_EXT_PAT</span><span class="p">:</span><span class="w"> </span><span class="l">$(AZDO_PERSONAL_ACCESS_TOKEN)</span><span class="w">
</span><span class="w">          </span><span class="nt">AZDO_PERSONAL_ACCESS_TOKEN</span><span class="p">:</span><span class="w"> </span><span class="l">$(AZDO_PERSONAL_ACCESS_TOKEN)</span><span class="w">
</span><span class="w">          </span><span class="nt">AZDO_ORG_SERVICE_URL</span><span class="p">:</span><span class="w"> </span><span class="l">$(AZDO_ORG_SERVICE_URL)</span><span class="w">
</span><span class="w">        </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">targetType</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;inline&#39;</span><span class="w">
</span><span class="w">          </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l">Invoke-Pester -EnableExit</span><span class="w">
</span><span class="w">
</span><span class="w">      </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">PowerShell@2</span><span class="w">
</span><span class="w">        </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Build devcontainer</span><span class="w">
</span><span class="w">        </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">targetType</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;inline&#39;</span><span class="w">
</span><span class="w">          </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l">docker build -f .devcontainer/Dockerfile -t devcontainer .</span><span class="w">
</span></code></pre></div><h3 id="classic-build-times">Classic build times</h3>
<p>Below we can see the time the build took. Installing dependencies locally is very fast, with majority of the time being spent on building the devcontainer. Looking at this, the best way to save time on your builds it by not using a devcontainer at all! Luckily, there are other benefits that more than make up for this gluttony.</p>
<p><img src="https://eliises.github.io/images/dockerizing-devops/classic-pipeline.png" alt="Classic pipeline"></p>
<h2 id="devcontainer-pipeline">Devcontainer pipeline</h2>
<p>Now lets do what we&rsquo;ve all been waiting for and convert the above pipeline to now instead run the tasks inside of the devcontainer:</p>
<h5 id="azdodevcontainer-pipelineymlhttpsgithubcomeliisesterraform-pester-devcontainer-exampleblobmasterazdodevcontainer-pipelineyml"><a href="https://github.com/EliiseS/terraform-pester-devcontainer-example/blob/master/.azdo/devcontainer-pipeline.yml">.azdo/devcontainer-pipeline.yml</a></h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">steps</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># Build the devcontainer</span><span class="w">
</span><span class="w">      </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">PowerShell@2</span><span class="w">
</span><span class="w">        </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Build devcontainer</span><span class="w">
</span><span class="w">        </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">targetType</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;inline&#39;</span><span class="w">
</span><span class="w">          </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l">docker build -f .devcontainer/Dockerfile -t devcontainer .</span><span class="w">
</span><span class="w">
</span><span class="w">      </span><span class="c"># Run checks inside the devcontainer</span><span class="w">
</span><span class="w">      </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">PowerShell@2</span><span class="w">
</span><span class="w">        </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Validate terraform</span><span class="w">
</span><span class="w">        </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">targetType</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;inline&#39;</span><span class="w">
</span><span class="w">          </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">            docker run `
</span><span class="sd">              --entrypoint /opt/microsoft/powershell/7/pwsh `
</span><span class="sd">              -v $(System.DefaultWorkingDirectory):/src `
</span><span class="sd">              --workdir /src `
</span><span class="sd">              devcontainer `
</span><span class="sd">              -c &#34;terraform init &amp;&amp; terraform validate &amp;&amp; tflint&#34;</span><span class="w">            
</span><span class="w">
</span><span class="w">      </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">PowerShell@2</span><span class="w">
</span><span class="w">        </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Run tests</span><span class="w">
</span><span class="w">        </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">AZDO_PERSONAL_ACCESS_TOKEN</span><span class="p">:</span><span class="w"> </span><span class="l">$(AZDO_PERSONAL_ACCESS_TOKEN)</span><span class="w">
</span><span class="w">          </span><span class="nt">AZDO_ORG_SERVICE_URL</span><span class="p">:</span><span class="w"> </span><span class="l">$(AZDO_ORG_SERVICE_URL)</span><span class="w">
</span><span class="w">        </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">targetType</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;inline&#39;</span><span class="w">
</span><span class="w">          </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">            docker run `
</span><span class="sd">              -e AZURE_DEVOPS_EXT_PAT=$(AZDO_PERSONAL_ACCESS_TOKEN) `
</span><span class="sd">              -e AZDO_PERSONAL_ACCESS_TOKEN=$(AZDO_PERSONAL_ACCESS_TOKEN) `
</span><span class="sd">              -e AZDO_ORG_SERVICE_URL=$(AZDO_ORG_SERVICE_URL) `
</span><span class="sd">              --entrypoint /opt/microsoft/powershell/7/pwsh `
</span><span class="sd">              -v $(System.DefaultWorkingDirectory):/src `
</span><span class="sd">              --workdir /src `
</span><span class="sd">              devcontainer `
</span><span class="sd">              -c Invoke-Pester -EnableExit</span><span class="w">            
</span></code></pre></div><h3 id="devcontainer-build-times">Devcontainer build times</h3>
<p>Below we can see that we&rsquo;ve shaved off a few seconds, but nothing amazing.</p>
<p><img src="https://eliises.github.io/images/dockerizing-devops/devcontainer-pipeline.png" alt="Devcontainer pipeline"></p>
<h2 id="devcontainer-pipeline-with-caching">Devcontainer pipeline with caching</h2>
<p>As a bonus, we can also cache our devcontainer image between runs to further reduce the time the builds take. Take a look at the YAML below:</p>
<h5 id="azdodevcontainer-caching-pipelineymlhttpsgithubcomeliisesterraform-pester-devcontainer-exampleblobmasterazdodevcontainer-caching-pipelineyml"><a href="https://github.com/EliiseS/terraform-pester-devcontainer-example/blob/master/.azdo/devcontainer-caching-pipeline.yml">.azdo/devcontainer-caching-pipeline.yml</a></h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># Initialize caching</span><span class="w">
</span><span class="w">      </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">Cache@2</span><span class="w">
</span><span class="w">        </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">docker-image | .devcontainer/**</span><span class="w">
</span><span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;.dockercache&#39;</span><span class="w">
</span><span class="w">          </span><span class="nt">restoreKeys</span><span class="p">:</span><span class="w"> </span><span class="l">docker-image</span><span class="w">
</span><span class="w">          </span><span class="nt">cacheHitVar</span><span class="p">:</span><span class="w"> </span><span class="l">DOCKER_CACHE_HIT</span><span class="w">
</span><span class="w">        </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Cache docker layers</span><span class="w">
</span><span class="w">
</span><span class="w">      </span><span class="c"># Load the cached image if cache was found</span><span class="w">
</span><span class="w">      </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">PowerShell@2</span><span class="w">
</span><span class="w">        </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Load cached devcontainer image</span><span class="w">
</span><span class="w">        </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l">eq(variables.DOCKER_CACHE_HIT, &#39;true&#39;)</span><span class="w">
</span><span class="w">        </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">targetType</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;inline&#39;</span><span class="w">
</span><span class="w">          </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l">docker load -i ./.dockercache/devcontainer.tar</span><span class="w">
</span><span class="w">
</span><span class="w">      </span><span class="c"># Build the devcontainer</span><span class="w">
</span><span class="w">      </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">PowerShell@2</span><span class="w">
</span><span class="w">        </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Build devcontainer&#39;</span><span class="w">
</span><span class="w">        </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">targetType</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;inline&#39;</span><span class="w">
</span><span class="w">          </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">            # Create dockercache directory
</span><span class="sd">            mkdir -p ./.dockercache/
</span><span class="sd">            docker build --cache-from devcontainer:latest -f .devcontainer/Dockerfile -t devcontainer .</span><span class="w">            
</span><span class="w">
</span><span class="w">      </span><span class="c"># Cache the docker image file if build succeeded</span><span class="w">
</span><span class="w">      </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">PowerShell@2</span><span class="w">
</span><span class="w">        </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Save devcontainer image</span><span class="w">
</span><span class="w">        </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l">and(succeeded(), ne(variables.DOCKER_CACHE_HIT, &#39;true&#39;))</span><span class="w">
</span><span class="w">        </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">targetType</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;inline&#39;</span><span class="w">
</span><span class="w">          </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l">docker image save -o ./.dockercache/devcontainer.tar devcontainer</span><span class="w">
</span><span class="w">
</span><span class="w">      </span><span class="c"># Run checks in the devcontainer</span><span class="w">
</span><span class="w">      </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">PowerShell@2</span><span class="w">
</span><span class="w">        </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Validate terraform</span><span class="w">
</span><span class="w">        </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">targetType</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;inline&#39;</span><span class="w">
</span><span class="w">          </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">            docker run `
</span><span class="sd">              --entrypoint /opt/microsoft/powershell/7/pwsh `
</span><span class="sd">              -v $(System.DefaultWorkingDirectory):/src `
</span><span class="sd">              --workdir /src `
</span><span class="sd">              devcontainer `
</span><span class="sd">              -c &#34;terraform init &amp;&amp; terraform validate &amp;&amp; tflint&#34;</span><span class="w">            
</span><span class="w">
</span><span class="w">      </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">PowerShell@2</span><span class="w">
</span><span class="w">        </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Run tests</span><span class="w">
</span><span class="w">        </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">AZDO_PERSONAL_ACCESS_TOKEN</span><span class="p">:</span><span class="w"> </span><span class="l">$(AZDO_PERSONAL_ACCESS_TOKEN)</span><span class="w">
</span><span class="w">          </span><span class="nt">AZDO_ORG_SERVICE_URL</span><span class="p">:</span><span class="w"> </span><span class="l">$(AZDO_ORG_SERVICE_URL)</span><span class="w">
</span><span class="w">        </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">targetType</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;inline&#39;</span><span class="w">
</span><span class="w">          </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">            docker run `
</span><span class="sd">              -e AZURE_DEVOPS_EXT_PAT=$(AZDO_PERSONAL_ACCESS_TOKEN) `
</span><span class="sd">              -e AZDO_PERSONAL_ACCESS_TOKEN=$(AZDO_PERSONAL_ACCESS_TOKEN) `
</span><span class="sd">              -e AZDO_ORG_SERVICE_URL=$(AZDO_ORG_SERVICE_URL) `
</span><span class="sd">              --entrypoint /opt/microsoft/powershell/7/pwsh `
</span><span class="sd">              -v $(System.DefaultWorkingDirectory):/src `
</span><span class="sd">              --workdir /src `
</span><span class="sd">              devcontainer `
</span><span class="sd">              -c Invoke-Pester -EnableExit</span><span class="w">            
</span></code></pre></div><h3 id="alternatives-to-caching">Alternatives to caching</h3>
<p>An alternatives to caching is using a container registry to save your image, such as the <a href="https://docs.microsoft.com/en-us/azure/container-registry/container-registry-intro">azure container registry</a> or <a href="https://docs.docker.com/docker-hub/">docker hub</a>. In fact <a href="https://github.com/lawrencegripper/azbrowse">AzBrowze</a> is using docker hub for it&rsquo;s caching.</p>
<h3 id="caching-build-times">Caching build times</h3>
<p>With cashing we can see that our run times actually increased the first time the build in run:</p>
<p><img src="https://eliises.github.io/images/dockerizing-devops/caching-pipeline.png" alt="Caching pipeline"></p>
<p>But on consecutive runs when we are retrieving the cache, it&rsquo;s lower overall.</p>
<p><img src="https://eliises.github.io/images/dockerizing-devops/caching-pipelines.png" alt="Caching pipelines"></p>
<h2 id="build-time-overview">Build time overview</h2>
<p>All the build times side-by-side:</p>
<p><img src="https://eliises.github.io/images/dockerizing-devops/all-pipelines.png" alt="All pipelines"></p>
<h2 id="execute-commands-in-container-locally">Execute commands in container locally</h2>
<p>For troubleshooting or verifying your commands will run in your container, you can also execute them in your local machine:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1">## Build the devcontainer</span>
docker build -t devcontainer -f ./.devcontainer/Dockerfile .
<span class="c1">## Execute commands in the container</span>
docker run <span class="sb">`</span>
        -e <span class="nv">AZURE_DEVOPS_EXT_PAT</span><span class="o">=</span><span class="nv">$env</span>:AZDO_PERSONAL_ACCESS_TOKEN <span class="sb">`</span>
        -e <span class="nv">AZDO_PERSONAL_ACCESS_TOKEN</span><span class="o">=</span><span class="nv">$env</span>:AZDO_PERSONAL_ACCESS_TOKEN <span class="sb">`</span>
        -e <span class="nv">AZDO_ORG_SERVICE_URL</span><span class="o">=</span><span class="nv">$env</span>:AZDO_ORG_SERVICE_URL <span class="sb">`</span>
        --entrypoint /opt/microsoft/powershell/7/pwsh <span class="sb">`</span>
        <span class="c1"># Replace `&lt;host/source/directory&gt;` with the local path to the repo</span>
        -v &lt;host/source/directory&gt;:/src <span class="sb">`</span>
        --workdir /src <span class="sb">`</span>
        devcontainer <span class="sb">`</span>
        <span class="c1"># Replace `Invoke-Pester` with your desired command</span>
        -c Invoke-Pester
</code></pre></div><h2 id="pros-and-cons">Pros and cons</h2>
<h3 id="cons">Cons</h3>
<ul>
<li>Building a docker image is slower than just installing dependencies
<ul>
<li>This con is negated if you&rsquo;re already using and build a devcontainer</li>
</ul>
</li>
<li>An alternative to running your build pipeline in a devcontainer is extracting dependency installation into a script and using that script in the pipeline and devcontainer.</li>
</ul>
<h3 id="pros">Pros</h3>
<ul>
<li>Consistent, traceable and fully automated creation of the environment (container) by a docker file</li>
<li>Standardized environment to use for all developers</li>
<li>Easy distribution of the container and its updates for all developers</li>
<li>Reduces the effort to maintain the environment in the pipeline through scripts or similar</li>
<li>Having an identical environment for the developers and the pipeline lowers the probability of errors resulting from inconsistent environments (e.g. different Go compiler version)</li>
</ul>
<h2 id="epilogue">Epilogue</h2>
<p>While I&rsquo;m clearly biased towards devcontainers I&rsquo;d love hear what everyone else thinks on the matter. And do let me know if I&rsquo;ve missed anything or if something is broken!</p>

          </div>

          
          <div class="row">
            <div class="col-md-8">
            
            </div>
            
          </div>
          

          
          <div class="row pt-3">
            <div class="col-md-6">
              
                <a href=https://eliises.github.io/posts/debug-tf-vscode/ class="post-meta">Previous
                  <div class="pt-2 pb-5 d-flex">
                    <i class="fas fa-angle-left text-grey font-weight-bold mr-2 active-color"></i>
                    <span>Debug Terraform (Azure Devops) Provider with VSCode</span>
                  </div>
                </a>
              
            </div>
            
            <div class="col-md-6 text-right" >
              
            </div>
          </div>

          

        </div>
        

      </div>
      

      
	
	
	
	
		
		
		
	

		
		<div class="col-md-2 pl-0">

			
			<div id="page-scrollspy" class="toc-nav">
				
				<ul class="nav nav-pills ml-0">
					
					<li class="nav-item pb-3 text-center">
						<span class="font-weight-bold mb-2">- CATALOG - </span>
					</li>

					
						
						
							
								
								
									<ul class="nav">
								
								

										<li class="nav-item">
						 					<a class="nav-link" href="#requirements">
												 Requirements
											</a>
										</li>
						 
								
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
								

										<li class="nav-item">
						 					<a class="nav-link" href="#about-the-project">
												 About the project
											</a>
										</li>
						 
								
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
									<ul class="nav">
								
								

										<li class="nav-item">
						 					<a class="nav-link" href="#ci-pipeline-checks">
												 CI pipeline checks
											</a>
										</li>
						 
								
								
									</ul>
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
								

										<li class="nav-item">
						 					<a class="nav-link" href="#classic-pipeline">
												 Classic pipeline
											</a>
										</li>
						 
								
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
									<ul class="nav">
								
								

										<li class="nav-item">
						 					<a class="nav-link" href="#classic-build-times">
												 Classic build times
											</a>
										</li>
						 
								
								
									</ul>
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
								

										<li class="nav-item">
						 					<a class="nav-link" href="#devcontainer-pipeline">
												 Devcontainer pipeline
											</a>
										</li>
						 
								
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
									<ul class="nav">
								
								

										<li class="nav-item">
						 					<a class="nav-link" href="#devcontainer-build-times">
												 Devcontainer build times
											</a>
										</li>
						 
								
								
									</ul>
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
								

										<li class="nav-item">
						 					<a class="nav-link" href="#devcontainer-pipeline-with-caching">
												 Devcontainer pipeline with caching
											</a>
										</li>
						 
								
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
									<ul class="nav">
								
								

										<li class="nav-item">
						 					<a class="nav-link" href="#alternatives-to-caching">
												 Alternatives to caching
											</a>
										</li>
						 
								
								
									</ul>
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
									<ul class="nav">
								
								

										<li class="nav-item">
						 					<a class="nav-link" href="#caching-build-times">
												 Caching build times
											</a>
										</li>
						 
								
								
									</ul>
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
								

										<li class="nav-item">
						 					<a class="nav-link" href="#build-time-overview">
												 Build time overview
											</a>
										</li>
						 
								
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
								

										<li class="nav-item">
						 					<a class="nav-link" href="#execute-commands-in-container-locally">
												 Execute commands in container locally
											</a>
										</li>
						 
								
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
								

										<li class="nav-item">
						 					<a class="nav-link" href="#pros-and-cons">
												 Pros and cons
											</a>
										</li>
						 
								
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
									<ul class="nav">
								
								

										<li class="nav-item">
						 					<a class="nav-link" href="#cons">
												 Cons
											</a>
										</li>
						 
								
								
									</ul>
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
									<ul class="nav">
								
								

										<li class="nav-item">
						 					<a class="nav-link" href="#pros">
												 Pros
											</a>
										</li>
						 
								
								
									</ul>
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
								

										<li class="nav-item">
						 					<a class="nav-link" href="#epilogue">
												 Epilogue
											</a>
										</li>
						 
								
								
									</ul>
								
							
						
				 

				</ul>
			</div>
			

		</div>
		
	

    </div>
    


  </main>
  


    
    

<footer class="page-footer text-center font-small mt-4 wow fadeIn">


  
  <div class="pb-2 mt-5 pt-5">
    
  <a href="//github.com/eliises" target="_blank" rel="noopener me"><i class="fab fa-github pr-1" aria-hidden="true"></i></a>    







  <a href="//linkedin.com/in/eliises" target="_blank" rel="noopener me"><i class="fab fa-linkedin pr-1" aria-hidden="true"></i></a>





  <a href="//twitter.com/eliises" target="_blank" rel="noopener me"><i class="fab fa-twitter pr-1" aria-hidden="true"></i></a>







  <a href="//dev.to/eliises" target="_blank" rel="noopener me"><i class="fab fa-dev pr-1" aria-hidden="true"></i></a>







  <a href="mailto:selingeliise@gmail.com"><i class="far fa-envelope-open pr-1" aria-hidden="true"></i></a>




  </div>
  

  
  <div class="copyright py-4">
    <span>  2016 - 2022 &copy; | Theme <a href='https://github.com/EliiseS/AllinOne' target="_blank">AllinOne</a> </span>
  </div>
  

</footer>


    






<script type="text/javascript" src="https://eliises.github.io/js/vendors/jquery/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="https://eliises.github.io/js/vendors/jquery/jquery.smooth-scroll.min.js"></script>



<script type="text/javascript" src="https://eliises.github.io/js/vendors/popper.min.js"></script>
<script type="text/javascript" src="https://eliises.github.io/js/vendors/holder.min.js"></script>
<script type="text/javascript" src="https://eliises.github.io/js/vendors-extensions/bootstrap4/bootstrap.min.js" ></script>

<script type="text/javascript" src="https://eliises.github.io/js/vendors/mdb/mdb.min.js"></script>

<script type="text/javascript" src="https://eliises.github.io/js/main.js"></script>



  
  <script src="https://eliises.github.io/js/vendors/highlight.pack.js"> </script>
  <script>hljs.initHighlightingOnLoad();</script>




 
  <script src="https://eliises.github.io/js/vendors/katex/katex.min.js"> </script>
  <script src="https://eliises.github.io/js/vendors/katex/contrib/auto-render.min.js"></script>

  <script>
      document.addEventListener("DOMContentLoaded", function () {
          renderMathInElement(document.body);
      });
  </script>




<script type="text/javascript">
  
  new WOW().init();
</script>




  </body>
</html>